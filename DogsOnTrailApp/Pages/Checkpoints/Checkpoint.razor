@page "/checkpoint/{ActionId?}/{CheckpointId?}"

@using System.Text.Json.Nodes
@using DogsOnTrailApp.Models
@using MapsterMapper
@using System.Globalization
@inject Protos.Checkpoints.Checkpoints.CheckpointsClient CheckpointsClient
@inject IStringLocalizer<Resource> Loc
@inject IMapper Mapper
@inject IJSRuntime JsRuntime

<h3>@Loc["Checkpoint.Title"]</h3>
<h5>@Loc["Checkpoint.Description"]</h5>

<div class="container">
    <div class="row">
        <div class="col-12">
            <input type="text" value="@ToString(Model.CheckpointTime)" disabled />
        </div>
        <div class="col-12">
            <Switch @bind-Value="ContinualGpsCoordinatesAcquiringIsOn" Label="@Loc["Checkpoint.GPS"]" />
        </div>
        <div class="col-12">
            <input type="text" value="@ToGpsCoordsString(Model.Position)" />
        </div>
        <div class="col-12">
            <input type="text" value="@Model.Data" />
        </div>
    </div>
</div>

<Button Type="ButtonType.Button" Color="ButtonColor.Primary" @onclick="ToggleCheckpointDetailsAsync">@Loc["Checkpoint.ShowDetails"]</Button>
<Collapse @ref="checkpointDetails">
    <Card>
        <CardBody>
            <div class="container">
                <div class="row">
                    <div class="col-sm-12 col-6">
                        <label>@Loc["Checkpoint.Name"]</label>
                    </div>
                    <div class="col-sm-12 col-6">
                        <input type="text" @bind="Model.Name" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-6">
                        <label>@Loc["Checkpoint.Description"]</label>
                    </div>
                    <div class="col-sm-12 col-6">
                        <input type="text" @bind="Model.Description" />
                    </div>
                </div>
            </div>
        </CardBody>
    </Card>
</Collapse>

<Button Type="ButtonType.Button" Color="ButtonColor.Primary" @onclick="ToggleQrReaderAsync">@Loc["Checkpoint.QrReader"]</Button>
<Collapse @ref="qrReader">
    <Card>
        <CardBody>
            <Switch @bind-Value="QrReaderIsOn" Label="@Loc["Checkpoint.QrReader"]" />

            <div class="card card-body">
                <div id="loadingMessage">🎥 Unable to access video stream (please make sure you have a webcam enabled)</div>
                <canvas id="canvas" hidden></canvas>

                <div id="output" hidden>
                    <div id="outputMessage">No QR code detected.</div>
                    <div hidden><b>Data:</b> <span id="outputData"></span></div>
                </div>
            </div>
        </CardBody>
    </Card>
</Collapse>

<button type="button" @onclick="() => SendDataAsync()">Send data</button>
  
@code {

    [Parameter]
    public Guid ActionId
    {
        get
        {
            return Model.ActionId; 
        }
        set
        {
            Model.ActionId = value;
        }
    }
    
    [Parameter]
    public Guid CheckpointId 
    {
        get
        {
            return Model.CheckpointId;
        }
        set
        {
            Model.CheckpointId = value;
        } 
    }
    
    private CheckpointModel Model { get; set; } = new();

    Collapse checkpointDetails = default!;
    private async Task ToggleCheckpointDetailsAsync() => await checkpointDetails.ToggleAsync();

    Collapse qrReader = default!;
    private async Task ToggleQrReaderAsync() => await qrReader.ToggleAsync();
    
    private bool ContinualGpsCoordinatesAcquiringIsOn = false;
    private bool QrReaderIsOn = false;
    
    private static Func<string, Task> UpdateQrCodeAsync;
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        UpdateQrCodeAsync = UpdateModelWithNewQrCode;
    }

    private async Task UpdateModelWithNewQrCode(string qrCode)
    {
        Model.Data = qrCode;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            StartGpsCoordinatesGetting();
            StartQrReader();
            StartCurrentTimeThread();
        }
    }
    
    [JSInvokable]
    public static async void QrCodeAcquiredAsync(string value)
    {
        await UpdateQrCodeAsync?.Invoke(value);
    }

    private string ToString(DateTimeOffset dateTimeOffset)
    {
        return dateTimeOffset.ToString("dd HH:mm:ss");
    }

    private string ToGpsCoordsString(CheckpointModel.LatLngDto position)
    {
        return $"{Model.Position.Latitude}N, {Model.Position.Longitude}E";
    }

    private async Task SendDataAsync()
    {
        var request = Mapper.Map<Protos.Checkpoints.AddCheckpoint.AddCheckpointRequest>(Model);
        
        await CheckpointsClient.addCheckpointAsync(request);
    }

    private void StartQrReader()
    {
        Task.Run(async () =>
        {
            while (true)
            {
                if (QrReaderIsOn)
                {
                    Model.Data = "";
                    StateHasChanged();

                    await Task.Run(async () => await JsRuntime.InvokeVoidAsync("readQrCode"));

                    while (QrReaderIsOn && Model.Data == "")
                    {
                        await Task.Delay(200);
                    }

                    QrReaderIsOn = false;
                    StopQrReader();
                }

                await Task.Delay(2000);
            }
        });
    }

    private void StopQrReader()
    {
        Task.Run(async () => await JsRuntime.InvokeVoidAsync("destroyQrReader"));
    }
    
    private void StartGpsCoordinatesGetting()
    {
        Task.Run(async () =>
        {
            while (true) 
            {
                if (ContinualGpsCoordinatesAcquiringIsOn)
                {
                    var result = await JsRuntime.InvokeAsync<JsonArray>("getGpsLocation");

                    if (result != null && result.Count >= 2)
                    {
                        Model.Position.Latitude = double.Parse(result[0].ToString(), CultureInfo.InvariantCulture);
                        Model.Position.Longitude = double.Parse(result[1].ToString(), CultureInfo.InvariantCulture);
                
                        StateHasChanged();
                    }
                }
                
                await Task.Delay(2000);
            }
        });
    }

    private void StartCurrentTimeThread()
    {
        Task.Run(async () =>
        {
            while (true)
            {
                Model.CheckpointTime = DateTimeOffset.Now;
                StateHasChanged();
                
                await Task.Delay(500);
            }
        });
    }
}