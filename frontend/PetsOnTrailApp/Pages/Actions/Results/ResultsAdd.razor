@using MapsterMapper
@using Protos.Results
@using PetsOnTrailApp.Shared
@using PetsOnTrailApp.Extensions
@using SharedLib.Extensions
@using SharedLib.Models
@using PetsOnTrailApp.Components
@using System.Text.RegularExpressions

@inject IStringLocalizer<Resource> Localizer
@inject Protos.Results.Results.ResultsClient ResultsClient
@inject IMapper Mapper

<h3>@Localizer["Results.Manage.Add"]</h3>
<section>
    <EditForm Model="@Model" OnValidSubmit="OnFormValid" OnInvalidSubmit="OnFormInvalid" FormName="FormResultAdd">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="container">
            <div class="form-group row">
                <label class="col-sm-3">@Localizer["Results.Manage.Add.Firstname"]</label>
                <InputText class="form-control col-sm-8" @bind-Value="@Model.FirstName" />
            </div>
            <div class="form-group row">
                <label class="col-sm-3">@Localizer["Results.Manage.Add.Lastname"]</label>
                <InputText class="form-control col-sm-8" @bind-Value="@Model.LastName" />
            </div>
            <div class="form-group row">
                <label class="col-sm-3">@Localizer["Results.Manage.Add.Pets"]</label>
                <InputText class="form-control col-sm-8" Value="@_pets" ValueChanged="PetsChanged" ValueExpression="() => _pets" placeholder="@Localizer["Results.Manage.Add.Pets.DividedByComma"]" />
            </div>
            <div class="form-group row">
                <label class="col-sm-3">@Localizer["Results.Manage.Add.State"]</label>
                <InputSelect class="form-control col-sm-8" Value="@State" ValueChanged="@((ActionModel.RaceState state) => RaceStateChanged(state))" ValueExpression="() => State">
                    <option value="@ActionModel.RaceState.NotValid">@Localizer["Results.Manage.Add.State.Choose"]</option>
                    <option value="@ActionModel.RaceState.NotStarted">@Localizer["Results.Manage.Add.State.NotStarted"]</option>
                    <option value="@ActionModel.RaceState.Started">@Localizer["Results.Manage.Add.State.Started"]</option>
                    <option value="@ActionModel.RaceState.Finished">@Localizer["Results.Manage.Add.State.Finished"]</option>
                    <option value="@ActionModel.RaceState.DidNotFinished">@Localizer["Results.Manage.Add.State.DidNotFinished"]</option>
                    <option value="@ActionModel.RaceState.Disqualified">@Localizer["Results.Manage.Add.State.Disqualified"]</option>
                </InputSelect>
            </div>
            <div class="form-group row" hidden="@(IsStartShown == false)">
                <label for="startDate" class="col-sm-3">@Localizer["Results.Manage.Add.Start"]</label>
                <InputDateTime id="startDate" class="form-control col-sm-8" @bind-Value="@Start" @onblur="StartIsFilled"></InputDateTime>
                <ValidationMessage class="offset-sm-3 col-sm-8" For="(()=>Start)"></ValidationMessage>
            </div>
            <div class="form-group row" hidden="@(IsFinishShown == false)">
                <label for="finishDate" class="col-sm-3">@Localizer["Results.Manage.Add.Finish"]</label>
                <InputDateTime id="finishDate" class="form-control col-sm-8" @bind-Value="@Finish" @onblur="FinishIsFilled"></InputDateTime>
                <ValidationMessage class="offset-sm-3 col-sm-8" For="(()=>Finish)"></ValidationMessage>
            </div>
            <div class="form-group row">
                <label class="col-sm-3">@Localizer["Results.Manage.Add.WholeTime"]</label>
                <InputText class="form-control col-sm-8" Value="@WholeTime" ValueChanged="WholeTimeChanged" ValueExpression="() => WholeTime" placeholder="hh:mm:ss / hh:mm / hh"></InputText>
            </div>
        </div>

        <div class="form-group row">
            <button type="submit" class="btn btn-primary">@Localizer["Results.Manage.Add.Submit"]</button>
        </div>
    </EditForm>
</section>


@code {
    [Parameter] public string ActionId { get; set; }
    [Parameter] public Guid RaceId { get; set; }
    [Parameter] public Guid CategoryId { get; set; }
    [Parameter] public DateTimeOffset RaceBegin { get; set; }
    [Parameter] public DateTimeOffset RaceEnd { get; set; }

    [Parameter]
    public EventCallback OnResultAddedCallback { get; set; }

    private ActionModel.RacerDto Model = new();
    private string WholeTime { get; set; } = string.Empty;
    private string _pets { get; set; } = string.Empty;

    private DateTimeOffset Start { get; set; }
    private DateTimeOffset Finish { get; set; }

    private ActionModel.RaceState State { get; set; } = ActionModel.RaceState.NotValid;

    private bool IsStartShown => (new List<ActionModel.RaceState>() 
                                    { 
                                        ActionModel.RaceState.Started,
                                        ActionModel.RaceState.Finished,
                                        ActionModel.RaceState.DidNotFinished,
                                        ActionModel.RaceState.Disqualified
                                    }).Contains(Model.State);

    private bool IsFinishShown => (new List<ActionModel.RaceState>() 
    { 
        ActionModel.RaceState.Finished,
    }).Contains(Model.State);

    protected override void OnInitialized()
    {
        Start = RaceBegin;
        Finish = RaceEnd;
    }

    private async Task OnFormValid()
    {
        AddResultRequest_FinalState resultState = AddResultRequest_FinalState.NotSpecified;
        switch (Model.State)
        {
            case ActionModel.RaceState.NotStarted:
                resultState = AddResultRequest_FinalState.Accepted;
                break;
            case ActionModel.RaceState.Started:
                resultState = AddResultRequest_FinalState.Started;
                break;
            case ActionModel.RaceState.Finished:
                resultState = AddResultRequest_FinalState.Finished;
                break;
            case ActionModel.RaceState.DidNotFinished:
                resultState = AddResultRequest_FinalState.Dnf;
                break;
            case ActionModel.RaceState.Disqualified:
                resultState = AddResultRequest_FinalState.Dsq;
                break;
        }


        await ResultsClient.addResultAsync(new AddResultRequest {
            ActionId = ActionId,
            RaceId = RaceId.ToString(),
            CategoryId = CategoryId.ToString(),
            FirstName = Model.FirstName,
            LastName = Model.LastName,
            Phone = Model.Phone,
            Email = Model.Email,
            Start = Model.Start.ToGoogleDateTime(),
            Finish = Model.Finish.ToGoogleDateTime(),
            Pets = { Model.Pets.Select(pet => pet.Name) },
            State = resultState
        });

        await OnResultAddedCallback.InvokeAsync((ActionId, RaceId, CategoryId, Model));
    }

    private async Task OnFormInvalid() {

    }

    private void StartIsFilled(FocusEventArgs args)
    {
        Console.WriteLine($"StartIsFilled with value: {Start}");

        Model.Start = Start;

        StartAndFinishIsFilledCountResult();
    }

    private void FinishIsFilled(FocusEventArgs args)
    {
        Console.WriteLine($"FinishIsFilled with value: {Finish}");

        Model.Finish = Finish;

        StartAndFinishIsFilledCountResult();
    }

    private void StartAndFinishIsFilledCountResult()
    {
        Console.WriteLine("StartAndFinishIsFilledCountResult");

        if (Model.Start.HasValue && Model.Finish.HasValue)
        {
            Console.WriteLine("StartAndFinishIsFilledCountResult - both filled");

            var diff = Model.Finish.Value.Subtract(Model.Start.Value);
            var hours = diff.TotalHours;

            diff -= TimeSpan.FromHours(hours);
            var minutes = diff.TotalMinutes;

            diff -= TimeSpan.FromMinutes(minutes);
            var seconds = diff.TotalSeconds;

            Console.WriteLine($"Hours: {hours}, Minutes: {minutes}, Seconds: {seconds}");
            WholeTime = $"{hours}:{minutes}:{seconds}";

            StateHasChanged();
        }
    }

    private void PetsChanged(string pets)
    {
        if (string.IsNullOrWhiteSpace(pets))
        {
            Model.Pets = new List<ActionModel.PetDto>();
            return;
        }

        var petsArray = pets.Split(new char[] { ',', ':', '.' });

        Model.Pets = petsArray
                        .Select(p => new ActionModel.PetDto { Name = p })
                        .ToList();
    }

    private void RaceStateChanged(ActionModel.RaceState state)
    {
        State = state;
        Model.State = state;

        StateHasChanged();
        // Is done with IsStartShown and IsFinishShown above..

        // Model.State = state switch
        // {
        //     ActionModel.RaceState.NotStarted => ActionModel.RaceState.NotStarted,
        //     ActionModel.RaceState.Started => ActionModel.RaceState.Started,
        // };
    }

    private void WholeTimeChanged(string val)
    {
        int hours = 0, minutes = 0, seconds = 0;

        if (Regex.IsMatch(val, @"^[a-zA-Z0-9,.:]+$") == false)
            return;

        string[] split = val.Split(new Char[] { ',', ':', '.' });
        switch (split.Length)
        {
            case 3: // hh:mm:ss
                hours = int.Parse(split[0]);
                minutes = int.Parse(split[1]);
                seconds = int.Parse(split[2]);
                break;

            case 2: // hh:mm
                hours = int.Parse(split[0]);
                minutes = int.Parse(split[1]);
                break;

            case 1: // hh
                hours = int.Parse(split[0]);
                break;

            default:
                break;
        }

        Model.Start = RaceBegin;
        Model.Finish = RaceBegin.AddHours(hours).AddMinutes(minutes).AddSeconds(seconds);

        StateHasChanged();
    }
}