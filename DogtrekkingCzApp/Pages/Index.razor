@inject GrpcChannel Channel
@inject AuthenticationStateProvider AuthStateProvider

@page "/"
@using Protos.UserProfiles

<PageTitle>Index</PageTitle>

<AuthorizeView>
    <Authorized>
        Jsi přihlášen jako @context.User.Identity?.Name!
    </Authorized>
    <NotAuthorized>
        Nejsi přihlášen
    </NotAuthorized>
</AuthorizeView>

@code {
    private Protos.UserProfiles.UserProfiles.UserProfilesClient _client = null;
    private AuthenticationState _authState = null;

    protected override async Task OnInitializedAsync()
    {
        _client = new UserProfiles.UserProfilesClient(Channel);
        _authState = await AuthStateProvider.GetAuthenticationStateAsync();

        if (_authState?.User?.Identity?.IsAuthenticated == true && _authState?.User?.Claims != null)
        {
            var claims = _authState.User.Claims;
            var emailClaim = claims.FirstOrDefault(claim => claim.Type == "email");
            
            if (emailClaim != null)
            {
                var request = new GetUserProfileRequest
                {
                    Email = emailClaim.Value
                };
                
                if (string.IsNullOrEmpty(request.Email) == false)
                {
                    var response = await _client.getUserProfileAsync(request);

                    if (response?.Id == null)
                    {
                        ; // start with registering user
                    }
                }
            }
        }
    }
}
