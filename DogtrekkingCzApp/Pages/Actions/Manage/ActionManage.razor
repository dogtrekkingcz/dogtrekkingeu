@page "/action_manage/{Id}"

@using DogtrekkingCzApp.Models
@using MapsterMapper

@inject Protos.Actions.Actions.ActionsClient Client
@inject AuthenticationStateProvider AuthStateProvider 
@inject IStringLocalizer<Resource> localizer
@inject IMapper mapper
@inject NavigationManager NavManager

<div>
    <EditForm Model="@Model" OnValidSubmit="SubmitForm">
        @if (RequiredAction != RequiredActionEnum.DeleteAction)
        {
            <DataAnnotationsValidator />
            <ValidationSummary />
        }
        
        <TabControl></TabControl>
        
        <TabControl>
            <TabPage Text="@localizer["Action main info"]">
                <ActionManageApprovesComponent Model="Model"></ActionManageApprovesComponent>
                <ActionManageMainInfoComponent Model="Model"></ActionManageMainInfoComponent>
            </TabPage>
            <TabPage Text="@localizer["Action location"]">
                <ActionManageLocationComponent Model="Model"></ActionManageLocationComponent>
            </TabPage>
            <TabPage Text="@localizer["Races definition"]">
                <ActionManageRacesComponent Model="Model"></ActionManageRacesComponent>
            </TabPage>
            <TabPage Text="@localizer["Action entries"]">
                ...
            </TabPage>
        </TabControl>
        
        <div class="container">
            <div class="row">
                <div class="col">
                    @if (RequiredAction == RequiredActionEnum.DeleteAction)
                    {
                        <button @onclick="@DeleteAction">@GetActionButtonText()</button>
                    }
                    else
                    {
                        <button type="submit">@GetActionButtonText()</button>
                    }
                </div>
                <div class="col">
                    <button @onclick="Cancel">@localizer["Cancel"]</button>
                </div>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public RequiredActionEnum RequiredAction { get; set; }

    [Parameter]
    public string Id { get; set; }

    public ActionModel Model { get; set; } = FixModel(new ActionModel());

    [CascadingParameter] BlazoredModalInstance BlazoredModal { get; set; } = default!;
    private string ActionButtonText { get; set; }
    
    [Parameter]
    public EventCallback<Protos.Actions.ActionDto> OnItemChanged { get; set; }

    private AuthenticationState _authState = null;
    
    protected override async Task OnInitializedAsync()
    {
        _authState = await AuthStateProvider.GetAuthenticationStateAsync();

        if (string.IsNullOrEmpty(Id) == false && Id != "0") {
            var getActionRequest = new Protos.Actions.GetActionRequest
            {
                Id = Id
            };
            var actionResponse = await Client.getActionAsync(getActionRequest);

            Model = mapper.Map<ActionModel>(actionResponse.Action);

            RequiredAction = RequiredActionEnum.UpdateAction;
        }
        else
        {
            RequiredAction = RequiredActionEnum.AddAction;
        }
    }

    

    private string GetActionButtonText()
    {
        switch (RequiredAction)
        {
            case RequiredActionEnum.AddAction: 
                return localizer["Add new action"]; 
                
            case RequiredActionEnum.UpdateAction: 
                return localizer["Update action"];
                
            case RequiredActionEnum.DeleteAction:
                return localizer["Delete action"];
        }

        return "";
    }
    
    private async Task SubmitForm()
    {
        if (RequiredAction == RequiredActionEnum.AddAction || string.IsNullOrEmpty(Model.Id) || Id == "0")
            await CreateNewAction();
        else if (RequiredAction == RequiredActionEnum.UpdateAction)
            await UpdateAction();
        
        NavManager.NavigateTo("/actions");
    }

    private async Task Cancel() => await BlazoredModal.CancelAsync();
    
    private async Task CreateNewAction()
    {
        Model = FixModel(Model);
        
        Model.Owner.Id = _authState.User.Claims.FirstOrDefault(claim => claim.Type == "oid")?.Value ?? "";
        Model.Owner.Email = _authState.User.Claims.FirstOrDefault(claim => claim.Type == "email")?.Value ?? "";
        Model.Owner.FirstName = _authState.User.Claims.FirstOrDefault(claim => claim.Type == "given_name")?.Value ?? "";
        Model.Owner.FamilyName = _authState.User.Claims.FirstOrDefault(claim => claim.Type == "family_name")?.Value ?? "";

        Model.Id = "";

        var item = new Protos.Actions.CreateActionRequest
        {
            Action = mapper.Map<Protos.Actions.ActionDto>(Model)
        };
        
        var result = await Client.createActionAsync(item);

        if (string.IsNullOrEmpty(result.Id) == false)
        {
            await OnItemChanged.InvokeAsync(item.Action);
        }
    }

    private async Task UpdateAction()
    {
        Model = FixModel(Model);

        var updateActionRequest = new Protos.Actions.UpdateActionRequest
        {
            Action = mapper.Map<Protos.Actions.ActionDto>(Model),
        };

        var result = await Client.updateActionAsync(updateActionRequest);
        
        NavManager.NavigateTo("/actions");
    }

    private async Task DeleteAction()
    {
        var deleteActionRequest = new Protos.Actions.DeleteActionRequest
        {
            Id = Model.Id
        };

        var result = await Client.deleteActionAsync(deleteActionRequest);

        NavManager.NavigateTo("/actions");
    }
    
    private static ActionModel FixModel(ActionModel model)
    {
        model.Id ??= "";
        model.Description ??= "";
        model.Term ??= new ActionModel.TermDto
        {
            From = DateTime.Now,
            To = DateTime.Now
        };
        model.Address ??= new()
        {
            City = "",
            Country = "",
            Region = "",
            Street = "",
            GpsLatitude = 0.0,
            GpsLongitude = 0.0
        };
        model.Flags ??= new()
        {
            CancelledReason = "",
            Approved = false,
            IsCanceled = false,
            IsHidden = false,
            TermLocked = false
        };
        model.Races ??= new List<ActionModel.RaceDto>();
        model.Owner ??= new()
        {
            Email = "",
            Id = "",
            FamilyName = "",
            FirstName = ""
        };

        return model;
    }
}